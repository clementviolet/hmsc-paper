# Materials & Methods

We used the HMSC (Hierarchical Modeling of Species Communities) framework applied to the long-term REBENT coastal monitoring dataset ([rebent.ifremer.fr](https://rebent.ifremer.fr)). In the following subsections, we sequentially describe +@fig:workflow : (1) the HMSC framework, (2) the data used in this study, (3) data splitting between training and testing sets to assess the explanatory and predictive powers of models, respectively, (4) the rationales for the suite of alternative models considered and, (5) the performance metrics used to compare models.

![Workflow of the study. A. Structure of a Hierarchical Model of Species Community (HMSC) including environmental variables, phylogeny and species-specific functional traits. B. Data pre-processing: community data partitioning between train and test datasets, estimating of phylogenetic distance between species (using taxonomic classification) and dimension reduction of species-trait matrix using a fuzzy-PCA. C. Summary of the four alternative model structures fitted both on presence/absence and abundance data: the Benchmark, Phylogeny and Traits & Phylogeny models only considered polychaete species assemblage data, while the Whole Community model includes information related to additional species sampled alongside the target assemblage (i.e. non-target species that are not of direct interest but potentially interact with the target assemblage). Random effects accounting for the sampling year, site and habitat were included in all models.](figures/fig1.png){#fig:workflow}

## Hierarchical Modelling of Species Community (HMSC)

“HMSC is a multivariate hierarchical generalised linear mixed model adjusted with Bayesian inference rooted in assembly theory” [@Ovaskainen_2020]. A HMSC model is composed of two parts: one taking into account fixed effects and the other taking into account random effects. The fixed part models the realised niche (i.e., the set of environmental conditions that is biotically suitable and accessible to the species; @Ovaskainen_2020) of each species (B matrix), where each dimension of the niche is a covariate (e.g. temperature) included in the model (+@fig:workflow ; @Ovaskainen_2020). Including trait data enables estimating of species-specific expected niche value by accounting for trait-environment relationships, where species with similar traits are expected to respond similarly along environmental gradients (+@fig:workflow ; @Ovaskainen_2017a ; @Ovaskainen_2020). It is well-established that phylogenetically-close species tend to share similar trait values or niches [@Wiens_2010]. Adding phylogenetic data to a HMSC model already including traits is not necessarily redundant because it could capture residual ecological information not included in the available trait data. This can theoretically improve species niche estimates [@Ovaskainen_2020]. Inclusion of such additional pieces of information can moreover improve model fit for rare species by borrowing information on traits- (or phylogenetic-) environment relationships estimated for common species that are similar in terms of traits (or phylogenetic; @Ovaskainen_2020). This property is a main advantage of hierarchical models [@Gelman_2020].

The random part of HMSC relies on latent variables. Specifically, for each random effect, two matrices of latent variables are estimated [@Ovaskainen_2017a ; @Tikhonov_2019b ; @Ovaskainen_2020]: the $\Eta$ matrix (called site loadings) contains the values of missing covariates not included in the model (+@fig:workflow ; @Ovaskainen_2017a ; @Ovaskainen_2020); while the $\Lambda$  matrix (called species loadings) corresponds to the response of the species to missing covariates (+@fig:workflow ; @Ovaskainen_2017a ; @Ovaskainen_2020). These covariates thus capture residual variance, which can be due to various factors including missing environmental features or the effect of biotic interactions [@Ovaskainen_2017b ; @Ovaskainen_2017a ; @Ovaskainen_2020].

## Datasets

### Faunistic data

Faunistic data come from the REBENT programme ([rebent.ifremer.fr](https://rebent.ifremer.fr)), which is a station-based ongoing monitoring network initiated in 2003  to detect, characterise and explain changes of coastal benthic macrofauna across Brittany’s coastline (Western France). Here, we focused on benthic infaunal communities found in two soft-bottom habitats: intertidal bare sediments and intertidal seagrass meadows (*Zostera marina*). Data from @Boye_2019a, covering 23 sites (Fig. S1) monitored using the same protocol between 2006 and 2014, were used in this study. At each site, sampling consists in the collection of three sediment cores of 0.03m$^2$ that are pooled together and considered as a single sampling unit at each site. For each sampling event, individuals were identified to the lowest taxonomic level possible (mostly species level; for simplicity we hereafter use the term “species"). A detailed description of the sampling methodology is provided in [@Boye_2017 ; @Boye_2019a]. Overall, across a total of 375 sampling units (i.e. unique combination of years, sites and habitats), 861,997 individuals belonging to 821 species were collected and identified.

### Functional traits and phylogeny data

We collated species-specific information related to functional traits and phylogeny for inclusion in different models. These data were particularly well resolved for the polychaete community which therefore constitutes the main object of inference. Polychaeta is a taxonomic group composed of numerous species exhibiting diverse lifestyles [@Jumars_2015] that can be used to monitor the health of benthic habitats [@Giangrande_2005]. The polychaete traits data, which was available for the 99 polychaete species present in the training set, includes 11 fuzzy-coded traits for a total of 41 modalities [@Boye_2019a]. Prior to jSDM fitting, the dimensionality of the trait matrix was reduced using a fuzzy-PCA with the *fpca* function from the *ade4* R package [@Thioulouse_2018]. The first three axes, which account for 59% of the total variance of the trait matrix, were included in the model as synthetic traits data (+@fig:workflow). The first axis distinguishes mobile predatory species from sessile microphages; the second axis differentiates semelparous species from iteroparous species; and, the third axis separates burrowers from tube-dwellers (Fig. S5).

In complement to the traits information available for the 99 polychaete species of interest, we retrieved their taxonomic classification through the WoRMS database ([www.marinespecies.org](https://www.marinespecies.org); assessed in  january 2020) and used this information as a proxy for phylogenetic relationships (+@fig:workflow ; @Ricotta_2012 ; @Ovaskainen_2020). Phylogenetic distances between polychaete species were then estimated using the *ape* R package  [@Paradis_2019].

### Environmental data

Following @Boye_2019a, we selected seven environmental variables to characterise the ecological niche of each species within the target community. These seven variables quantify different components of coastal environmental variability including hydrology (sea water temperature, salinity and current velocity), sedimentology (mud and organic matter content), substrate heterogeneity (Trask index) and local wave exposure (fetch). For each of these seven variables, the first and second degree polynomials were computed to account for non-linear responses.

## Comparison of alternative model structures

The first model (benchmark model abbreviated as “Bench”) only relies on polychaete community data and environmental covariates (+@fig:workflow). The second model (phylogenetic model abbreviated as “Ph”) adds phylogenetic data to the Bench model (+@fig:workflow), which implies that rare species can thus benefit from phylogenetic-environment relationships estimated for closely related species [@Ives_2011]. The third model (traits & phylogeny model abbreviated as “TrPh”) adds traits data to the Ph model (+@fig:workflow), which means that rare species can benefit from traits-environment relationships estimated for species presenting similar functional traits (whereas phylogeny can capture ecological similarities between species, which are not captured by trait similarity; @Pollock_2012). Finally, the fourth model (whole community model abbreviated as “WhC”), adds information about the whole community (i.e. including non-polychaete species for a total of 278 species) to the Bench model (only 99 polychaete; +@fig:workflow). This model does not include trait or phylogenetic data for the sake of computation time. Each of these four models were fitted twice, either using presence/absence or abundance data. All models include the same random effects (+@fig:workflow): a temporal random effect to account for variability across years, a spatial random effect to account for variability across sites and another spatial random effect to account for variability across habitats (bare vs seagrass).


## Model fitting and performance

### Model fitting using Markov Chain Monte Carlo 

HMSC uses a Bayesian framework for model fitting where the posterior distribution is sampled using a MCMC algorithm. For each model we ran 15 chains, each with 30,000 iterations. The first 10,000 iterations were discarded as burn-in while the remaining were thinned every 20 iterations yielding 1,000 posterior samples per chain. Hence, in total, 15,000 posterior samples were recorded for each parameter. Model convergence for each model parameter was assessed using the potential scale reduction factor [@Gelman_1992].

### Assessing model performance and interpretability

In order to independently assess models’ predictive performance, we splitted the dataset into a train and a test set. The training dataset includes 180 sampling units defined as unique combinations of years (varies between six and nine depending on sites), sites (21) and two habitats (Fig. S1). From this dataset, that originally contained 519 species, we removed the species that occurred less than four times across the 180 observational units to avoid convergence issues and poor model inference, leading to the removal of 241 species. The remaining 278 species encompassed the 99 polychaete species that made up the target community and the 142 non-target species that were included in the WhC model. The test dataset was composed of 35 sampling units related to all surveys over a 9-year period at two specific sites , where both habitats (i.e. seagrass and bare sand) occur. Beyond the presence of both habitats, these two sites were also chosen because they occur in environmental conditions that can be considered average at the scale of the region (thereby limiting extrapolation of the model; @Boye_2017 ; @Boye_2022 ; @Toumi_nd) while still harbouring different communities, representative of the known diversity gradient across the region [@Boye_2017 ; @Toumi_nd].

To investigate jSDM’s performance, models were evaluated using a set of complementary metrics to evaluate both their explanatory (predictions compared to observations of the train dataset) and predictive (predictions compared to observations of the test dataset) powers [@Wilkinson_2020]. To assess models’ performance, both overall (i.e., across all species) and at individual species level, we used AUC and root mean squared errors (RMSE) for  presence/absence and abundance models, respectively. For the “whole community” model that most improved predictive power (see results), we further explored species-specific gain in explanatory power by examining potential correlations between (i) RMSE and the proportion of presences and (ii) RMSE and average abundance using the Kendall rank correlation coefficient.

While the AUC and the RMSE provide estimates of model performance, either overall or for individual species, these measures only partially capture model accuracy (or performance) at the community scale. Hence, we also explored differences between observed and predicted community composition (both for the train and test datasets) by decomposing the total beta diversity (using the Sørensen index) into species turnover and nestedness using the *betapart.temp* function from the *betapart* R package [@Baselga_2010 ; @Baselga_2022]. For abundance models, predictions were transformed to presence/absence before computing beta diversity (i.e. all non-zero abundance predictions were considered as presences). Thus, this framework assigns a total beta diversity of zero to a model predicting the exact observed community, whereas a model predicting a completely different community compared to observations is associated with a total beta diversity of one. Moreover, using Baselga *et al.* (2022)’s framework, we decomposed beta diversity (i.e. predicted error in community composition) according to two components: (1) turnover, if model correctly estimates observed species richness but mispredicts species identity and (2) nestedness, if model correctly predicts the identity of observed species but omits some.

To assess model interpretability, we calculated the proportion of explained variance attributed either to environmental covariates (fixed effects) or to random effects. To evaluate the effect of model structure on estimated species-environment relationships, we classified the shapes of estimated response curves inferred from the different models according to nine categories that characterise both their direction (decline, null or increase) and their acceleration (decelerated, constant or accelerated) [@Rigal_2020]. We then looked for differences between models in terms of proportion of estimated response curves across each of these nine categories.
Finally, to compare changes in random effects across models, we estimated differences between the Bench model and the best performing model in terms of residual co-occurrence patterns. We specifically quantified differences between models in both magnitude and sign of residual species-species correlations using the following index:

$$\text{Index} = |corr_{\text{best model}} - corr_{\text{benchmark}}| \times sign(corr_{\text{best model}} \times corr_{\text{benchmark}})$$