# Methods & Materials

We used the HMSC (Hierarchical Modeling of Species Communities) framework applied to the long-term REBENT coastal monitoring dataset ([rebent.ifremer.fr](https://rebent.ifremer.fr)). In the following subsections, we sequentially describe: (1) the HMSC framework;(2) the data used in this study; (3) data splitting between training and testing sets to assess the explanatory and predictive powers of models, respectively; (4) the rationales for the suite of alternative models considered; and, (5) the performance metrics used to compare models.

![Workflow of the study. A. Hierarchical design of a HMSC model set-up with environmental variables, phylogeny and traits. B. Data acquisition workflow. C. Configuration of the differents models.](figures/fig1.png){#fig:workdlow}

## Hierarchical Modelling of Species Community (HMSC)

"HMSC is a multivariate hierarchical generalised linear mixed model adjusted with Bayesian inference rooted in assembly theory" [@Ovaskainen_2020]. A HMSC model is composed of two parts: one taking into account fixed effects and the other taking into account random effects. The fixed part models the realised niche  (i.e., the set of environmental conditions that is biotically suitable and accessible to the species; @Ovaskainen_2020) of each species (B matrix), where each dimension of the niche is a covariate (e.g. temperature) included in the model [@Ovaskainen_2020]. Including trait data enables estimating of species-specific expected niche value by accounting for trait-environment relationships, where species with similar traits are expected to respond similarly along environmental gradients [@Ovaskainen_2017a ; @Ovaskainen_2020]. It is well-established that phylogenetically-close species tend to share similar trait values or niches [@Wiens_2010]. Adding phylogenetic data to a HMSC model already including traits is not necessarily redundant because it could capture residual ecological information not included in the available trait data. This can theoretically enhance estimating of species niches [@Ovaskainen_2020]. Inclusion of such additional pieces of information can moreover  improve model fit for rare species by borrowing information on traits- (or phylogenetic-) environment relationships estimated for common species that are similar in terms of  traits (or phylogenetic;  @Ovaskainen_2020). This property is a main advantage of hierarchical models [@Gelman_2020].

The random part of HMSC relies on latent variables. Specifically, for each random effect, two matrices of latent variables are estimated  [@Ovaskainen_2017a ; @Tikhonov_2019b ; @Ovaskainen_2020]: the $H$ matrix (called *site loadings*) contains the values of missing covariates not included in the model [@Ovaskainen_2017a ; @Ovaskainen_2020]; while the $\Lambda$ matrix (called *species loadings*) corresponds to the response of the species to missing covariates [@Ovaskainen_2017a ; @Ovaskainen_2020]. These covariates thus capture residual variance, which can be due to various factors including missing environmental features or the effect of biotic interactions [@Ovaskainen_2017a ; @Ovaskainen_2017b ; @Ovaskainen_2020].

## Datasets

### Faunistic data

Faunistic data come from the REBENT program ([rebent.ifremer.fr](https://rebent.ifremer.fr)), which is a station-based monitoring network initiated following the dramatic oil spill of the Erika tanker in December 1999 off Brittany’s southern coastline (Western France). The goal of the monitoring network is to detect, characterise and explain changes in French coastal benthic ecosystems through space and time. Between 2003 and 2017, this ongoing program has been monitoring four distinct habitats across 49 sites. Overall, across a total of  375 sampling units (i.e. unique combination of years, sites and habitats), 861,997 individuals belonging to 821 species were collected and identified since the beginning of the program Here, we focused on benthic communities found in two soft-bottom habitats: intertidal bare sediments and intertidal seagrass meadows (*Zostera marina*). These habitats were sampled following the same protocol across 23 sites along Brittany’s coastline (Fig S1). At each site, sampling consists in collection of 3 sediment cores of 0.03m2 that are pooled together and considered as a single sampling unit at each site. For each sampling event, individuals were identified to the lowest taxonomic level possible (mostly species level). A detailed  description of the sampling methodology is provided in @Boye_2017.

### Functional traits and phylogeny data

In this study, we collated species-specific information such as functional traits and phylogeny for inclusion in different models. We chose to focus on a particular class, the polychaeta. Polychaeta, which encompasses numerous species that  exhibit diverse lifestyles [@Jumars_2015], are valuable indicators of  the health of benthic habitats [@Giangrande_2005]. The polychaeta traits data, which was available for the 99 polychaeta species in the training set, includes 11 fuzzy-coded traits for a total of 41 modalities [@Boye_2019a]. Prior to jSDM fitting, the dimensionality of the trait matrix was reduced using a fuzzy-PCA with the *fpca* function from the *ade4* R package [@Thioulouse_2018]. The first three axes, which account for 59% of the total variance of the trait matrix, were included in the model as  synthetic traits data (Fig S5). The first axis distinguishes mobile predatory species from sessile microphages; the second axis differentiates semelparous species from iteroparous species; and, the third axis separates burrowers from tube-dwellers (Fig S5).

In complement to the traits information available for the 99 polychaeta species of interest, we retrieved their taxonomic classification through the WoRMS database ([www.marinespecies.org](https://www.marinespecies.org)) and used this information as a proxy for phylogenetic relationships [@Ovaskainen_2020 ; @Ricotta_2012]. Phylogenetic distances between Polychaeta species were then estimated using the *ape* R package [@Paradis_2019].

### Environmental data

Based on @Boye_2019b,  we selected seven environmental variables to characterise the ecological niche of each species within the focal communities. These seven variables quantify different components of coastal environmental variability including hydrology (sea water temperature, salinity and current velocity), sedimentology (mud and organic matter content), granulometry (Trask index) and local wave exposure (fetch). For each variable, the first and second degree polynomials have been computed to account for non-linear responses to the environmental predictors.

## Comparison of alternative model structures

The first model (benchmark model abbreviated as  “Bench”) only relies on  polychaeta community data and environmental covariates. The second model (phylogenetic model abbreviated as “Ph”) adds phylogenetic data to the Bench model, which implies that rare species can thus benefit from phylogenetic-environment relationships estimated for closely related species [@Ives_2011]. The third model (traits-phylogeny model abbreviated as “TrPh”) adds traits data to the Ph model, which means that rare species can benefit from traits-environment relationships estimated for species presenting similar functional traits (whereas phylogeny can capture ecological similarities between species, which are not captured by trait similarity; [@Pollock_2012]). Finally, the fourth model (whole community model abbreviated as “Whc”), adds information about the whole community (i.e. non-polychaeta species that represents 278 taxa) to the Bench model (only 99 polychaeta). This model does not include trait or phylogenetic data for the sake of computation time. Each of these four models were fitted twice, either using occurrence or abundance data. All models include the same random effects: a temporal random effect to account for variability across years, a spatial random effect to account for variability across sites and another spatial random effect to account for variability across habitats (bare vs seagrass).

## Model fitting and performance

### Model fitting using Markov Chain Monte Carlo 

HMSC uses a Bayesian framework for model fitting where the posterior distribution is sampled using a MCMC algorithm. For each model we ran 15 chains, each with 30,000 iterations. The first 10,000 iterations were discarded as burn-in while the remaining were thinned every 20 iterations yielding 1,000 posterior samples per chain. Hence, in total, 15,000 posterior samples were recorded for each parameter. Model convergence for each model parameter was assessed using the potential scale reduction factor [@Gelman_1992].

### Assessing model performance and interpretability

In order to independently assess models’ predictive performance, the REBENT dataset was split into a train and a test dataset. The *training dataset* includes 180 sampling units defined as unique combinations of years (varies between 6 and 9 depending on sites), sites (21) and habitats (2). From this dataset, we removed the species that occurred less than 4 times across the 180 observational units to avoid convergence issues and poor model inference, leading to the removal of 241 species. The remaining 278 species encompassed the 99 polychaeta species that made up the target community and the 142 accompanying species that were included in the *Whc* model. The *test dataset* was composed of 35 sampling units resulting from surveys conducted across two specific sites (9 years for both), which included the two habitats. To investigate jSDM’s performance, models were evaluated using a set of complementary metrics to evaluate both their explanatory (predictions compared to observations of the train dataset) and predictive (predictions compared to observations of the test dataset) powers [@Wilkinson_2020]. The performance of all models was assessed globally but also separately for each species using AUC for occurrence-based models and root mean squared errors (RMSE) for abundance-based models. We investigated whether models including additional sources of information had a higher performance than the *Bench* model using Dunn’s multiple comparison test [@Dunn_1964]. For the model that demonstrated the best improvement, we examined whether the improvement correlated with individual species occurrence or abundance (e.g., is the improvement higher for abundant species relative to than for rare species?) using the Kendall rank correlation coefficient.

While the AUC and the RMSE can be used to explore model performance globally or for each species, these measures provide no information at the community scale. Hence, we also explored qualitatively the differences between observed and predicted community composition (both for the train and test datasets) by decomposing the total beta diversity (using the Sørensen index) into species turnover and nestedness using the *betapart.temp* function from the betapart R package [@Baselga_2010 ; @Baselga_2022]. For abundance-based models, predictions were transformed to presence/absence before computing beta diversity (i.e. all predictions with abundance different than zero were considered as presences). Under this framework, a model predicting the exact observed community would have a total beta diversity of zero whereas a model predicting a community completely different from the one observed would have a total beta diversity of one. As outlined above, the Baselga’s framework allows decomposition into two components the type of error when predicting community composition: (1) getting the identity of the species wrong (turnover) or (2) predicting the right species but omitting some (nestedness). In the first case, the model will correctly predict specific richness, while in the other case the model will be more conservative in predicting the correct species but present a bias in species richness.

To assess model interpretability, we calculated the proportion of explained variance attributed either to environmental covariates (fixed effects) or to random effects. To evaluate the effect of model structure on estimated species-environment relationships, we classified the shapes of the response curves inferred from the different models according to both their direction (decline, null or increase) and their acceleration (decelerated, constant or accelerated), providing nine different categories [@Rigal_2020]. We then  looked for differences between models regarding the proportion of response curves attributed to each category. 

Finally, we checked the extent to which estimated correlation coefficients differed between the Bench model and the best performing model while also looking for evidence of inversion of effects using the following index:

$$\text{Index} = |corr_{\text{best model}} - corr_{\text{benchmark}}| * sign(corr_{\text{best model}} * corr_{\text{benchmark}})$$